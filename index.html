<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Home & Security Dashboard</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #2563eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --purple: #8b5cf6;
            --dark: #1e293b;
            --text-main: #334155;
            --text-muted: #64748b;
            --bg: #f1f5f9;
            --card-bg: #ffffff;
            --border-radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            min-height: 100vh;
            padding: 20px;
        }

        /* --- Header & Status --- */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg);
            padding: 15px 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }

        .brand {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .brand i { color: var(--primary); }

        .connection-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            background: #e2e8f0;
            color: var(--text-muted);
            transition: all 0.3s ease;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--text-muted);
        }

        .connected .connection-badge { background: #dcfce7; color: #166534; }
        .connected .status-indicator { background-color: var(--success); box-shadow: 0 0 0 2px #dcfce7; }
        
        .disconnected .connection-badge { background: #fee2e2; color: #991b1b; }
        .disconnected .status-indicator { background-color: var(--danger); animation: pulse 1.5s infinite; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* --- Layout Grid --- */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 24px;
        }

        .section-title {
            grid-column: span 12;
            font-size: 0.9rem;
            color: var(--text-muted);
            font-weight: 700;
            margin-top: 10px;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #e2e8f0;
        }

        /* --- Cards --- */
        .sensor-card {
            grid-column: span 12;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s;
        }

        .sensor-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
        }

        .sensor-card:hover { transform: translateY(-3px); }

        /* Responsive Columns for Sensors */
        /* Tablet: 2 per row */
        @media (min-width: 640px) { .sensor-card { grid-column: span 6; } }
        /* Desktop: 4 per row (Fits Temp, Humid, Light, Pressure nicely) */
        @media (min-width: 1024px) { .sensor-card { grid-column: span 3; } } 
        /* For 5 items (Air Quality wraps), or we can do a different span logic */
        
        /* Specific sizing for Air Quality if we want it to span wider on last row */
        @media (min-width: 1024px) { 
            .card-air { grid-column: span 12; } /* Full width bottom bar for Air Quality */
        }
        @media (min-width: 1280px) { 
            .sensor-card { grid-column: span 2; } /* 5 items fit roughly? No 12/5 is hard. Let's keep grid simple */
            .sensor-card { grid-column: span 3; } /* 4 per row */
            .card-air { grid-column: span 12; } /* Air Quality full width */
        }

        /* RFID and Log Logic */
        .card-rfid { grid-column: span 12; }
        @media (min-width: 1024px) { .card-rfid { grid-column: span 4; } }

        .log-panel {
            grid-column: span 12;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            max-height: 400px;
        }
        @media (min-width: 1024px) { .log-panel { grid-column: span 8; } }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .icon-box {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: #eff6ff;
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .card-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            font-weight: 600;
        }

        .metric-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--dark);
            line-height: 1;
        }

        .metric-unit {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-muted);
            margin-left: 4px;
        }

        /* Card Colors */
        .card-rfid .icon-box { background: #f3e8ff; color: #7e22ce; }
        .card-rfid::before { background: #7e22ce; }
        
        .card-temp .icon-box { background: #fee2e2; color: var(--danger); }
        .card-temp::before { background: var(--danger); }
        
        .card-humid .icon-box { background: #dbeafe; color: var(--primary); }
        .card-humid::before { background: var(--primary); }

        .card-light .icon-box { background: #fef3c7; color: var(--warning); }
        .card-light::before { background: var(--warning); }

        .card-pressure .icon-box { background: #ede9fe; color: var(--purple); }
        .card-pressure::before { background: var(--purple); }

        .card-air .icon-box { background: #dcfce7; color: var(--success); }
        .card-air::before { background: var(--success); }

        /* --- Log Styling --- */
        .log-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 600;
            color: var(--dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .log-list {
            overflow-y: auto;
            padding: 0;
            margin: 0;
            list-style: none;
            height: 300px;
        }

        .log-item {
            padding: 15px 24px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: space-between;
            animation: slideIn 0.3s ease;
        }
        
        .log-info { display: flex; flex-direction: column; gap: 4px; }
        .log-uid { font-family: monospace; font-weight: 600; font-size: 1.1em; color: var(--dark); }
        .log-time { font-size: 0.8rem; color: var(--text-muted); }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .badge-success { background: #dcfce7; color: #166534; }
        .badge-danger { background: #fee2e2; color: #991b1b; }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* --- Controls --- */
        .control-panel {
            grid-column: span 12;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
        }

        .control-item {
            background: var(--card-bg);
            box-shadow: var(--shadow);
            border-radius: var(--border-radius);
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .control-item:hover { transform: translateY(-2px); border-color: #e2e8f0; }
        .control-item.active { border-color: var(--success); background: #f0fdf4; }

        .control-info { display: flex; align-items: center; gap: 15px; }
        .control-icon { 
            width: 40px; height: 40px; border-radius: 50%; background: #f1f5f9; 
            display: flex; alignItems: center; justify-content: center; color: var(--text-muted);
        }
        .control-item.active .control-icon { background: var(--success); color: white; }

        /* Toggle Switch */
        .toggle {
            position: relative;
            width: 48px;
            height: 26px;
            background: #cbd5e1;
            border-radius: 13px;
            transition: 0.3s;
        }

        .toggle::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .active .toggle { background: var(--success); }
        .active .toggle::after { transform: translateX(22px); }

        /* --- Toast Notification --- */
        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 1000;
        }

        .toast {
            background: var(--dark);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }

    </style>
</head>
<body>

    <nav class="navbar">
        <div class="brand">
            <i class="fa-solid fa-layer-group"></i>
            IoT Dashboard
        </div>
        <div id="connectionStatus" class="disconnected">
            <div class="connection-badge">
                <div class="status-indicator"></div>
                <span id="statusText">Connecting...</span>
            </div>
        </div>
    </nav>

    <div class="container">
        
        <div class="section-title">Environmental Data</div>

        <div class="sensor-card card-temp">
            <div class="card-header">
                <span class="card-label">Temperature</span>
                <div class="icon-box"><i class="fa-solid fa-temperature-half"></i></div>
            </div>
            <div>
                <span class="metric-value" id="temp">--</span><span class="metric-unit">°C</span>
            </div>
        </div>

        <div class="sensor-card card-humid">
            <div class="card-header">
                <span class="card-label">Humidity</span>
                <div class="icon-box"><i class="fa-solid fa-droplet"></i></div>
            </div>
            <div>
                <span class="metric-value" id="humidity">--</span><span class="metric-unit">%</span>
            </div>
        </div>

        <div class="sensor-card card-light">
            <div class="card-header">
                <span class="card-label">Light Intensity</span>
                <div class="icon-box"><i class="fa-solid fa-sun"></i></div>
            </div>
            <div>
                <span class="metric-value" id="light">--</span><span class="metric-unit">%</span>
            </div>
        </div>

        <div class="sensor-card card-pressure">
            <div class="card-header">
                <span class="card-label">Atm. Pressure</span>
                <div class="icon-box"><i class="fa-solid fa-gauge-high"></i></div>
            </div>
            <div>
                <span class="metric-value" id="pressure">--</span><span class="metric-unit">hPa</span>
            </div>
        </div>

        <div class="sensor-card card-air">
            <div class="card-header">
                <span class="card-label">Air Quality Index</span>
                <div class="icon-box"><i class="fa-solid fa-wind"></i></div>
            </div>
            <div>
                <span class="metric-value" id="airquality">--</span><span class="metric-unit">PPM</span>
            </div>
        </div>


        <div class="section-title">Security & Access Control</div>

        <div class="sensor-card card-rfid">
            <div class="card-header">
                <span class="card-label">RFID Scanner</span>
                <div class="icon-box"><i class="fa-solid fa-id-card"></i></div>
            </div>
            <div>
                <span class="metric-value" id="rfidUid" style="font-size: 1.5rem; font-family: monospace;">--:--:--:--</span>
            </div>
            <div class="card-footer" style="margin-top: 15px; font-size: 0.9rem;">
                <span id="rfidStatus" style="color: var(--text-muted);">Waiting for card...</span>
            </div>
        </div>

        <div class="log-panel">
            <div class="log-header">
                <span><i class="fa-solid fa-list-check" style="margin-right: 8px;"></i> Access History</span>
                <span style="font-size: 0.8rem; color: var(--text-muted);">Last 10 Entries</span>
            </div>
            <ul class="log-list" id="accessLog">
                <li style="padding: 20px; text-align: center; color: var(--text-muted);">No access attempts recorded yet.</li>
            </ul>
        </div>


        <div class="section-title">Device Controls</div>

        <div class="control-panel">
            <div class="control-item" id="gateControl">
                <div class="control-info">
                    <div class="control-icon"><i class="fa-solid fa-door-open"></i></div>
                    <div>
                        <div style="font-weight: 600;">Main Gate</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);" id="gateStatusText">Closed</div>
                    </div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button onclick="sendControl('gate-open')" style="padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd; background: white; cursor: pointer;">Open</button>
                    <button onclick="sendControl('gate-close')" style="padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd; background: white; cursor: pointer;">Close</button>
                </div>
            </div>

            <div class="control-item" id="fanControl" onclick="sendControl('fan-toggle')">
                <div class="control-info">
                    <div class="control-icon"><i class="fa-solid fa-fan"></i></div>
                    <span style="font-weight: 600;">Fan</span>
                </div>
                <div class="toggle"></div>
            </div>

            <div class="control-item" id="lightControl" onclick="sendControl('light-toggle')">
                <div class="control-info">
                    <div class="control-icon"><i class="fa-solid fa-lightbulb"></i></div>
                    <span style="font-weight: 600;">Light</span>
                </div>
                <div class="toggle"></div>
            </div>
        </div>

    </div>

    <div class="toast-container">
        <div id="toast" class="toast">
            <i id="toastIcon" class="fa-solid fa-circle-check"></i>
            <span id="toastMessage">System Ready</span>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script>
        // --- Configuration ---
        const MQTT_SERVER = "afc8a0ac2ccf462c8f92b932403518df.s1.eu.hivemq.cloud";
        const MQTT_PORT = 8884;
        const MQTT_USER = "hivemq.webclient.1761751067946";
        const MQTT_PASS = "wy.b7f8cB*0GTUW&4Ha:";
        
        const TOPIC_SENSORS = "project/sensors";
        const TOPIC_STATUS = "project/status";
        const TOPIC_CONTROL = "project/control";
        const TOPIC_RFID = "project/rfid";

        let client;
        let reconnectAttempts = 0;

        // --- Initialization ---
        window.addEventListener('load', () => {
            connectMQTT();
        });

        // --- MQTT Logic ---
        function connectMQTT() {
            const clientId = "web-client-" + Math.random().toString(16).substr(2, 8);
            client = new Paho.MQTT.Client(MQTT_SERVER, MQTT_PORT, clientId);

            client.onConnectionLost = onConnectionLost;
            client.onMessageArrived = onMessageArrived;

            const options = {
                useSSL: true,
                userName: MQTT_USER,
                password: MQTT_PASS,
                onSuccess: onConnect,
                onFailure: onFailure,
                keepAliveInterval: 30
            };

            updateConnectionUI("connecting", "Connecting...");
            client.connect(options);
        }

        function onConnect() {
            console.log("✅ MQTT Connected");
            updateConnectionUI("connected", "System Online");
            reconnectAttempts = 0;
            
            client.subscribe(TOPIC_SENSORS);
            client.subscribe(TOPIC_STATUS);
            client.subscribe(TOPIC_RFID);
            
            showToast("Connected Successfully", "success");
        }

        function onFailure(error) {
            console.error("❌ Connection failed:", error.errorMessage);
            updateConnectionUI("disconnected", "Connection Failed");
            setTimeout(connectMQTT, 5000);
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.warn("⚠️ Connection Lost");
                updateConnectionUI("disconnected", "Reconnecting...");
                setTimeout(connectMQTT, 3000);
            }
        }

        function onMessageArrived(message) {
            try {
                const data = JSON.parse(message.payloadString);
                
                if (message.destinationName === TOPIC_RFID) {
                    handleRfidScan(data);
                } else {
                    updateDashboard(data);
                }
            } catch (e) {
                console.error("JSON Parse Error:", e);
            }
        }

        // --- Dashboard Update Logic ---
        function updateDashboard(data) {
            // Environment Data
            if (data.dht_temp) document.getElementById('temp').textContent = data.dht_temp.toFixed(1);
            if (data.dht_humidity) document.getElementById('humidity').textContent = data.dht_humidity.toFixed(1);
            if (data.lightPercent !== undefined) document.getElementById('light').textContent = data.lightPercent.toFixed(0);
            if (data.pressure_hpa !== undefined) document.getElementById('pressure').textContent = data.pressure_hpa.toFixed(1);
            if (data.mq135 !== undefined) document.getElementById('airquality').textContent = data.mq135;

            // Controls
            updateControlState('fanControl', data.fan);
            updateControlState('lightControl', data.light);

            // Gate Visual Status
            if (data.gate !== undefined) {
                const gateEl = document.getElementById('gateControl');
                const gateText = document.getElementById('gateStatusText');
                if (data.gate) {
                    gateEl.classList.add('active');
                    gateText.textContent = "Open";
                    gateText.style.color = "var(--success)";
                } else {
                    gateEl.classList.remove('active');
                    gateText.textContent = "Closed";
                    gateText.style.color = "var(--text-muted)";
                }
            }
        }

        function handleRfidScan(data) {
            // 1. Update Scanner Card
            const uidEl = document.getElementById('rfidUid');
            const statusEl = document.getElementById('rfidStatus');
            const cardEl = document.querySelector('.card-rfid');

            uidEl.textContent = data.uid || "Unknown";

            if (data.authorized) {
                statusEl.textContent = "✅ Access Granted";
                statusEl.style.color = "var(--success)";
                statusEl.style.fontWeight = "bold";
                showToast("Access Granted: Gate Opening", "success");
                
                // Visual Pulse
                cardEl.style.border = "2px solid var(--success)";
                setTimeout(() => cardEl.style.border = "none", 2000);
            } else {
                statusEl.textContent = "❌ Access Denied";
                statusEl.style.color = "var(--danger)";
                statusEl.style.fontWeight = "bold";
                showToast("Unauthorized Access Attempt", "error");
                
                // Visual Pulse
                cardEl.style.border = "2px solid var(--danger)";
                setTimeout(() => cardEl.style.border = "none", 2000);
            }

            // 2. Add to Log
            addToLog(data);
        }

        function addToLog(data) {
            const list = document.getElementById('accessLog');
            
            // Remove "No access attempts" message if it exists
            if (list.children.length === 1 && list.children[0].textContent.includes("No access")) {
                list.innerHTML = '';
            }

            // Create Log Item
            const li = document.createElement('li');
            li.className = 'log-item';
            
            const timeStr = new Date().toLocaleTimeString();
            const badgeClass = data.authorized ? 'badge-success' : 'badge-danger';
            const iconClass = data.authorized ? 'fa-check' : 'fa-ban';
            const statusText = data.authorized ? 'Authorized' : 'Denied';

            li.innerHTML = `
                <div class="log-info">
                    <span class="log-uid">${data.uid}</span>
                    <span class="log-time"><i class="fa-regular fa-clock"></i> ${timeStr}</span>
                </div>
                <div class="status-badge ${badgeClass}">
                    <i class="fa-solid ${iconClass}"></i> ${statusText}
                </div>
            `;

            // Add to top
            list.insertBefore(li, list.firstChild);

            // Limit to 10 entries
            if (list.children.length > 10) {
                list.removeChild(list.lastChild);
            }
        }

        function updateControlState(id, isActive) {
            const el = document.getElementById(id);
            if (!el) return;
            if (isActive) el.classList.add('active');
            else el.classList.remove('active');
        }

        function sendControl(command) {
            if (!client || !client.isConnected()) {
                showToast("Offline: Cannot send command", "error");
                return;
            }

            const message = new Paho.MQTT.Message(command);
            message.destinationName = TOPIC_CONTROL;
            client.send(message);
            console.log("Sent:", command);
        }

        // --- UI Helpers ---
        function updateConnectionUI(state, text) {
            const container = document.getElementById('connectionStatus');
            const txt = document.getElementById('statusText');
            
            container.className = "";
            if (state === 'connected') container.classList.add('connected');
            else container.classList.add('disconnected');
            
            txt.textContent = text;
        }

        function showToast(msg, type) {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toastMessage');
            const toastIcon = document.getElementById('toastIcon');

            toast.className = `toast ${type}`;
            toastMsg.textContent = msg;
            toastIcon.className = type === 'success' ? "fa-solid fa-circle-check" : "fa-solid fa-triangle-exclamation";
            
            toast.classList.add('show');
            if (toast.timeoutId) clearTimeout(toast.timeoutId);
            toast.timeoutId = setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
