<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTech Mini Project</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* --- Theme Variables --- */
            --bg-color: #eceff4;      /* Slate Background */
            --parent-card-bg: #ffffff;
            --inner-card-bg: #f8fafc;
            
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            
            /* Status Colors */
            --accent-orange: #f97316;
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --accent-cyan: #06b6d4;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            --border: 1px solid #e2e8f0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-primary); min-height: 100vh; padding: 20px; }

        /* --- Layout Structure --- */
        .app-layout {
            display: flex;
            gap: 24px;
            max-width: 1400px;
            margin: 0 auto;
            align-items: flex-start;
        }

        /* --- Sidebar Navigation --- */
        .sidebar {
            width: 260px;
            flex-shrink: 0;
            background: var(--parent-card-bg);
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--shadow);
            position: sticky;
            top: 20px;
            height: calc(100vh - 40px);
            display: flex;
            flex-direction: column;
        }

        .brand-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #f1f5f9;
            text-align: center;
        }
        .brand-section h2 { font-size: 1.2rem; font-weight: 700; color: var(--text-primary); }
        .brand-section p { font-size: 0.8rem; color: var(--text-secondary); }

        .nav-card {
            background: var(--inner-card-bg);
            border: 1px solid transparent;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .nav-card:hover { border-color: #cbd5e1; transform: translateX(4px); background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        .nav-card.active {
            background: #eff6ff;
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }
        .nav-card.active i { color: var(--accent-blue); }
        .nav-card i { font-size: 1.2rem; color: var(--text-secondary); transition: 0.2s; }
        .nav-card span { font-weight: 600; font-size: 0.95rem; }

        /* --- Main Content --- */
        .main-content { flex-grow: 1; width: 100%; }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .header-left h1 { font-size: 1.8rem; font-weight: 700; color: #0f172a; }
        .header-left p { color: var(--text-secondary); font-size: 0.9rem; }

        .status-badge {
            background: white;
            padding: 8px 16px;
            border-radius: 50px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .pulse-dot { width: 10px; height: 10px; border-radius: 50%; background-color: #d1d5db; }
        .pulse-dot.online { background-color: var(--accent-green); box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2); }
        .pulse-dot.offline { background-color: var(--accent-red); animation: pulse-red 1.5s infinite; }

        /* --- Dashboard Cards --- */
        .parent-card {
            background: var(--parent-card-bg);
            border-radius: 16px;
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .section-title i { color: var(--accent-blue); }

        /* Grids */
        .monitoring-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 24px; }
        .control-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 24px; }

        /* Widgets */
        .widget-card {
            background: var(--inner-card-bg);
            border-radius: 12px;
            padding: 20px;
            border: var(--border);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 150px;
            transition: all 0.2s ease;
            flex: 0 1 calc(33.333% - 16px); 
            min-width: 250px; 
        }
        .widget-card:hover { border-color: #cbd5e1; transform: translateY(-2px); }

        .widget-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .widget-label { font-size: 0.85rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        .widget-value { font-size: 2.2rem; font-weight: 700; color: var(--text-primary); }
        .unit { font-size: 1rem; font-weight: 500; color: var(--text-secondary); margin-left: 4px; }
        .widget-footer { margin-top: 15px; font-size: 0.8rem; color: var(--text-secondary); display: flex; align-items: center; gap: 5px; }

        /* Icon Boxes */
        .icon-box { width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1rem; }
        .bg-orange { background: #fff7ed; color: var(--accent-orange); }
        .bg-blue { background: #eff6ff; color: var(--accent-blue); }
        .bg-purple { background: #f5f3ff; color: var(--accent-purple); }
        .bg-green { background: #ecfdf5; color: var(--accent-green); }
        .bg-cyan { background: #ecfeff; color: var(--accent-cyan); }

        /* Toggles & Controls */
        .control-row { display: flex; justify-content: space-between; align-items: center; margin-top: auto; }
        
        .toggle-wrapper {
            position: relative; width: 52px; height: 28px; background: #cbd5e1; border-radius: 14px; cursor: pointer; transition: 0.3s; flex-shrink: 0;
        }
        .toggle-wrapper::after {
            content: ''; position: absolute; top: 3px; left: 3px; width: 22px; height: 22px; background: white; border-radius: 50%; transition: 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .toggle-active { background: var(--accent-green); }
        .toggle-active::after { transform: translateX(24px); }

        /* --- Surveillance Specific --- */
        .video-container {
            width: 100%;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            aspect-ratio: 16 / 9; /* Widescreen ratio */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        #surveillanceFeed {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none; /* Hidden by default until feed connects */
        }

        .video-placeholder {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: #64748b;
        }

        .live-badge {
            position: absolute; top: 15px; right: 15px;
            background: rgba(239, 68, 68, 0.9); color: white;
            padding: 4px 12px; border-radius: 4px;
            font-size: 0.75rem; font-weight: 700; text-transform: uppercase;
            display: none; animation: blink 1s infinite;
        }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* Responsive Breakpoints */
        @media (max-width: 900px) {
            .app-layout { flex-direction: column; }
            .sidebar { width: 100%; height: auto; position: relative; margin-bottom: 20px; }
            .widget-card { flex: 0 1 calc(50% - 12px); }
        }
        @media (max-width: 600px) { .widget-card { flex: 1 1 100%; } }

        /* Toast Notifications */
        .toast {
            position: fixed; bottom: 30px; right: 30px; background: #1e293b; color: white; padding: 12px 24px; border-radius: 8px; opacity: 0; transform: translateY(20px); transition: 0.3s; z-index: 1000;
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
    </style>
</head>
<body>

    <div class="app-layout">

        <aside class="sidebar">
            <div class="brand-section">
                <h2>IoT System</h2>
                <p> Control Panel</p>
            </div>
            
            <div class="nav-card active" onclick="switchPage('dashboard', this)">
                <i class="fa-solid fa-gauge"></i>
                <span>Dashboard</span>
            </div>

            <div class="nav-card" onclick="switchPage('surveillance', this)">
                <i class="fa-solid fa-video"></i>
                <span>Surveillance</span>
            </div>
        </aside>

        <main class="main-content">
            
            <header class="dashboard-header">
                <div class="header-left">
                    <h1 id="pageTitle">Home Automation</h1>
                    <p>Real-time Overview</p>
                </div>
                <div class="status-badge">
                    <div id="connectionDot" class="pulse-dot"></div>
                    <span id="connectionText">Connecting...</span>
                </div>
            </header>

            <div id="page-dashboard">
                
                <div class="parent-card">
                    <div class="section-title"><i class="fa-solid fa-chart-line"></i>Monitoring Data</div>
                    <div class="monitoring-grid">
                        <div class="widget-card">
                            <div class="widget-header"><span class="widget-label">Temperature</span><div class="icon-box bg-orange"><i class="fa-solid fa-temperature-half"></i></div></div>
                            <div class="widget-value"><span id="temp">--</span><span class="unit">°C</span></div>
                            <div class="widget-footer"><i class="fa-solid fa-circle-check" style="color:var(--accent-green)"></i> Normal Range</div>
                        </div>
                        <div class="widget-card">
                            <div class="widget-header"><span class="widget-label">Humidity</span><div class="icon-box bg-blue"><i class="fa-solid fa-droplet"></i></div></div>
                            <div class="widget-value"><span id="humidity">--</span><span class="unit">%</span></div>
                            <div class="widget-footer">Relative Humidity</div>
                        </div>
                        <div class="widget-card">
                            <div class="widget-header"><span class="widget-label">Pressure</span><div class="icon-box bg-purple"><i class="fa-solid fa-gauge-high"></i></div></div>
                            <div class="widget-value"><span id="pressure">--</span><span class="unit">hPa</span></div>
                            <div class="widget-footer">Atmospheric</div>
                        </div>
                        <div class="widget-card">
                            <div class="widget-header"><span class="widget-label">Air Quality</span><div class="icon-box bg-green"><i class="fa-solid fa-wind"></i></div></div>
                            <div class="widget-value"><span id="airquality">--</span><span class="unit">PPM</span></div>
                            <div class="widget-footer" id="airStatusText">Analyzing...</div>
                        </div>
                        <div class="widget-card">
                            <div class="widget-header"><span class="widget-label">Brightness</span><div class="icon-box bg-orange"><i class="fa-solid fa-sun"></i></div></div>
                            <div class="widget-value"><span id="light">--</span><span class="unit">%</span></div>
                            <div class="widget-footer">Ambient Light</div>
                        </div>
                    </div>
                </div>

                <div class="parent-card">
                    <div class="section-title"><i class="fa-solid fa-sliders"></i>Device Control</div>
                    <div class="control-grid">
                        <div class="widget-card" onclick="sendControl('fan-toggle')">
                            <div class="widget-header"><span class="widget-label">Ventilation</span><div class="icon-box bg-cyan"><i class="fa-solid fa-fan"></i></div></div>
                            <div class="control-row"><span style="font-weight:600;">System Fan</span><div id="fanToggle" class="toggle-wrapper"></div></div>
                        </div>
                        <div class="widget-card" onclick="sendControl('light-toggle')">
                            <div class="widget-header"><span class="widget-label">Lighting</span><div class="icon-box bg-orange"><i class="fa-solid fa-lightbulb"></i></div></div>
                            <div class="control-row"><span style="font-weight:600;">Main Lamp</span><div id="lightToggle" class="toggle-wrapper"></div></div>
                        </div>
                        <div class="widget-card" onclick="toggleGate()">
                            <div class="widget-header"><span class="widget-label">Access Control</span><div class="icon-box bg-purple"><i class="fa-solid fa-dungeon"></i></div></div>
                            <div class="control-row">
                                <div style="display:flex; flex-direction:column;"><span style="font-weight:600;">Main Gate</span><span id="gateStatusText" style="font-size: 0.8rem; color: var(--text-secondary);">Closed</span></div>
                                <div id="gateToggle" class="toggle-wrapper"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="page-surveillance" style="display: none;">
                <div class="parent-card">
                    <div class="section-title">
                        <i class="fa-solid fa-video"></i>
                        Live Camera Feed
                    </div>
                    
                    <div class="video-container">
                        <div class="live-badge" id="liveBadge">LIVE</div>
                        
                        <img id="surveillanceFeed" src="" alt="Live Stream">
                        
                        <div id="videoPlaceholder" class="video-placeholder">
                            <i class="fa-solid fa-eye-slash" style="font-size: 3rem; margin-bottom: 20px; color: #cbd5e1;"></i>
                            <h3>Feed Offline</h3>
                            <p id="videoStatusMsg">Connecting to Video Server...</p>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <div id="toast" class="toast">Action Sent</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>

    <script>
        // ▼▼▼ CONFIGURATION: PASTE YOUR RENDER BACKEND URL HERE ▼▼▼
        const RENDER_VIDEO_URL = "https://live-feed-9d9b.onrender.com"; 
        // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

        // === 1. PAGE NAVIGATION LOGIC ===
        function switchPage(pageId, navElement) {
            // Hide all pages
            document.getElementById('page-dashboard').style.display = 'none';
            document.getElementById('page-surveillance').style.display = 'none';
            
            // Show selected page
            document.getElementById('page-' + pageId).style.display = 'block';
            
            // Update Title
            const titles = { 'dashboard': 'Dashboard', 'surveillance': 'Surveillance' };
            document.getElementById('pageTitle').innerText = titles[pageId];

            // Update Navigation Active State
            const navCards = document.querySelectorAll('.nav-card');
            navCards.forEach(card => card.classList.remove('active'));
            if(navElement) navElement.classList.add('active');
        }

        // === 2. VIDEO STREAMING LOGIC (SOCKET.IO) ===
        // This connects to your Render backend to get frames from the laptop
        const videoSocket = io(RENDER_VIDEO_URL);
        const imgEl = document.getElementById('surveillanceFeed');
        const placeholderEl = document.getElementById('videoPlaceholder');
        const badgeEl = document.getElementById('liveBadge');
        const statusMsg = document.getElementById('videoStatusMsg');

        videoSocket.on('connect', () => {
            console.log("✅ Connected to Render Video Server");
            statusMsg.innerText = "Waiting for Camera Source...";
        });

        videoSocket.on('new_frame_for_viewers', (data) => {
            // If we receive a frame, show the image and hide the placeholder
            imgEl.style.display = 'block';
            placeholderEl.style.display = 'none';
            badgeEl.style.display = 'block';
            
            // Update the image source with the Base64 data
            imgEl.src = data; 
        });

        videoSocket.on('disconnect', () => {
            console.log("❌ Video Server Disconnected");
            imgEl.style.display = 'none';
            placeholderEl.style.display = 'flex';
            badgeEl.style.display = 'none';
            statusMsg.innerText = "Server Disconnected";
        });

        // === 3. SENSOR & CONTROL LOGIC (MQTT) ===
        const MQTT_SERVER = "afc8a0ac2ccf462c8f92b932403518df.s1.eu.hivemq.cloud";
        const MQTT_PORT = 8884;
        const MQTT_USER = "hivemq.webclient.1761751067946";
        const MQTT_PASS = "wy.b7f8cB*0GTUW&4Ha:";
        
        const TOPIC_SENSORS = "project/sensors";
        const TOPIC_STATUS = "project/status";
        const TOPIC_CONTROL = "project/control";

        let mqttClient;

        window.addEventListener('load', connectMQTT);

        function connectMQTT() {
            const clientId = "web-" + Math.random().toString(16).substr(2, 8);
            mqttClient = new Paho.MQTT.Client(MQTT_SERVER, MQTT_PORT, clientId);
            mqttClient.onConnectionLost = onConnectionLost;
            mqttClient.onMessageArrived = onMessageArrived;

            const options = {
                useSSL: true,
                userName: MQTT_USER,
                password: MQTT_PASS,
                onSuccess: onConnect,
                onFailure: onFailure,
                keepAliveInterval: 30
            };
            
            updateStatusUI(false, "Connecting to HiveMQ...");
            mqttClient.connect(options);
        }

        function onConnect() {
            console.log("✅ MQTT Connected");
            updateStatusUI(true, "System Online");
            mqttClient.subscribe(TOPIC_SENSORS);
            mqttClient.subscribe(TOPIC_STATUS);
            showToast("Connected to Sensors");
        }

        function onFailure(e) {
            console.error(e);
            updateStatusUI(false, "Connection Failed");
            setTimeout(connectMQTT, 5000);
        }

        function onConnectionLost(response) {
            if (response.errorCode !== 0) {
                updateStatusUI(false, "Reconnecting...");
                setTimeout(connectMQTT, 3000);
            }
        }

        function onMessageArrived(msg) {
            try {
                const data = JSON.parse(msg.payloadString);
                updateDashboard(data);
            } catch (e) { console.error(e); }
        }

        function updateDashboard(data) {
            // Update Sensors
            if (data.dht_temp) document.getElementById('temp').textContent = data.dht_temp.toFixed(1);
            if (data.dht_humidity) document.getElementById('humidity').textContent = data.dht_humidity.toFixed(1);
            if (data.pressure_hpa) document.getElementById('pressure').textContent = data.pressure_hpa.toFixed(1);
            if (data.lightPercent !== undefined) document.getElementById('light').textContent = data.lightPercent.toFixed(0);
            
            if (data.mq135 !== undefined) {
                document.getElementById('airquality').textContent = data.mq135;
                const status = data.mq135 > 1000 ? "Poor Quality" : "Good Quality";
                const el = document.getElementById('airStatusText');
                el.textContent = status;
                el.style.color = data.mq135 > 1000 ? "var(--accent-red)" : "var(--accent-green)";
            }

            // Update Controls
            updateToggle('fanToggle', data.fan);
            updateToggle('lightToggle', data.light);
            
            // Update Gate UI
            if (data.gate !== undefined) {
                const txt = document.getElementById('gateStatusText');
                const toggle = document.getElementById('gateToggle');
                if (data.gate) {
                    txt.textContent = "OPEN";
                    txt.style.color = "var(--accent-green)";
                    toggle.classList.add('toggle-active');
                } else {
                    txt.textContent = "CLOSED";
                    txt.style.color = "var(--text-secondary)";
                    toggle.classList.remove('toggle-active');
                }
            }
        }

        function updateToggle(id, active) {
            const el = document.getElementById(id);
            if(active) el.classList.add('toggle-active');
            else el.classList.remove('toggle-active');
        }

        function toggleGate() {
             const toggle = document.getElementById('gateToggle');
             const isActive = toggle.classList.contains('toggle-active');
             sendControl(isActive ? 'gate-close' : 'gate-open');
        }

        function sendControl(cmd) {
            if (!mqttClient || !mqttClient.isConnected()) return showToast("Offline - Cannot send");
            const msg = new Paho.MQTT.Message(cmd);
            msg.destinationName = TOPIC_CONTROL;
            mqttClient.send(msg);
            showToast("Command Sent: " + cmd);
        }

        function updateStatusUI(isConnected, text) {
            const dot = document.getElementById('connectionDot');
            const txt = document.getElementById('connectionText');
            txt.textContent = text;
            if(isConnected) {
                dot.className = "pulse-dot online";
                txt.style.color = "var(--accent-green)";
            } else {
                dot.className = "pulse-dot offline";
                txt.style.color = "var(--text-secondary)";
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
