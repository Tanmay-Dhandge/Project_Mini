<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Control Center</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #2563eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1e293b;
            --text-main: #334155;
            --text-muted: #64748b;
            --bg: #f1f5f9;
            --card-bg: #ffffff;
            --border-radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            min-height: 100vh;
            padding: 20px;
        }

        /* --- Header & Status --- */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg);
            padding: 15px 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }

        .brand {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .brand i { color: var(--primary); }

        .connection-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            background: #e2e8f0;
            color: var(--text-muted);
            transition: all 0.3s ease;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--text-muted);
        }

        .connected .connection-badge { background: #dcfce7; color: #166534; }
        .connected .status-indicator { background-color: var(--success); box-shadow: 0 0 0 2px #dcfce7; }
        
        .disconnected .connection-badge { background: #fee2e2; color: #991b1b; }
        .disconnected .status-indicator { background-color: var(--danger); animation: pulse 1.5s infinite; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* --- Layout Grid --- */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 24px;
        }

        .section-title {
            grid-column: span 12;
            font-size: 1.1rem;
            color: var(--text-muted);
            font-weight: 600;
            margin-top: 10px;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* --- Sensor Cards --- */
        .sensor-card {
            grid-column: span 12;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s;
        }

        .sensor-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
        }

        .sensor-card:hover { transform: translateY(-3px); }

        @media (min-width: 640px) { .sensor-card { grid-column: span 6; } }
        @media (min-width: 1024px) { .sensor-card { grid-column: span 4; } } /* 3 per row */
        @media (min-width: 1280px) { .sensor-card { grid-column: span 2; } .sensor-card.wide { grid-column: span 4; } }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .icon-box {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: #eff6ff;
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .card-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            font-weight: 600;
        }

        .metric-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--dark);
            line-height: 1;
        }

        .metric-unit {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-muted);
            margin-left: 4px;
        }

        .card-footer {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e2e8f0;
            font-size: 0.8rem;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
        }

        /* Color Variances */
        .card-temp .icon-box { background: #fee2e2; color: var(--danger); }
        .card-temp::before { background: var(--danger); }
        
        .card-humid .icon-box { background: #dbeafe; color: var(--primary); }
        .card-humid::before { background: var(--primary); }
        
        .card-air .icon-box { background: #dcfce7; color: var(--success); }
        .card-air::before { background: var(--success); }
        
        .card-light .icon-box { background: #fef3c7; color: var(--warning); }
        .card-light::before { background: var(--warning); }

        /* --- Controls --- */
        .control-panel {
            grid-column: span 12;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
        }

        .control-item {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 16px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.2s;
        }

        .control-item:hover {
            border-color: #cbd5e1;
            background: #f1f5f9;
        }

        .control-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .control-info i {
            font-size: 1.2rem;
            color: var(--text-muted);
        }

        .control-name {
            font-weight: 600;
            color: var(--dark);
        }

        /* Toggle Switch */
        .toggle {
            position: relative;
            width: 50px;
            height: 28px;
            background: #cbd5e1;
            border-radius: 14px;
            transition: 0.3s;
        }

        .toggle::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .active .toggle { background: var(--success); }
        .active .toggle::after { transform: translateX(22px); }
        
        .control-item.active .control-info i { color: var(--success); }

        /* Manual Mode Specifics */
        .manual-mode .toggle { background: var(--warning); }
        .manual-mode .control-info i { color: var(--warning); }

        /* --- Footer --- */
        .footer {
            grid-column: span 12;
            text-align: center;
            margin-top: 40px;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        /* --- Toast Notification --- */
        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 1000;
        }

        .toast {
            background: var(--dark);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }

    </style>
</head>
<body id="appBody">

    <nav class="navbar">
        <div class="brand">
            <i class="fa-solid fa-house-signal"></i>
            Smart Home
        </div>
        <div id="connectionStatus" class="disconnected">
            <div class="connection-badge">
                <div class="status-indicator"></div>
                <span id="statusText">Connecting...</span>
            </div>
        </div>
    </nav>

    <div class="container">
        
        <div class="section-title">Environmental Monitoring</div>

        <div class="sensor-card card-temp">
            <div class="card-header">
                <span class="card-label">Temperature</span>
                <div class="icon-box"><i class="fa-solid fa-temperature-half"></i></div>
            </div>
            <div>
                <span class="metric-value" id="temp">--</span><span class="metric-unit">¬∞C</span>
            </div>
            <div class="card-footer">
                <span>DHT: <b id="dht-temp">--</b>¬∞C</span>
                <span>BMP: <b id="bmp-temp">--</b>¬∞C</span>
            </div>
        </div>

        <div class="sensor-card card-humid">
            <div class="card-header">
                <span class="card-label">Humidity</span>
                <div class="icon-box"><i class="fa-solid fa-droplet"></i></div>
            </div>
            <div>
                <span class="metric-value" id="humidity">--</span><span class="metric-unit">%</span>
            </div>
            <div class="card-footer">
                <span>Relative Humidity</span>
            </div>
        </div>

        <div class="sensor-card">
            <div class="card-header">
                <span class="card-label">Atmospheric Pressure</span>
                <div class="icon-box"><i class="fa-solid fa-gauge-high"></i></div>
            </div>
            <div>
                <span class="metric-value" id="pressure">--</span><span class="metric-unit">hPa</span>
            </div>
            <div class="card-footer">
                <span>Barometric Sensor</span>
            </div>
        </div>

        <div class="sensor-card card-light">
            <div class="card-header">
                <span class="card-label">Light Intensity</span>
                <div class="icon-box"><i class="fa-solid fa-sun"></i></div>
            </div>
            <div>
                <span class="metric-value" id="light">--</span><span class="metric-unit">%</span>
            </div>
            <div class="card-footer">
                <span>Ambient Sensor</span>
            </div>
        </div>

        <div class="sensor-card card-air wide">
            <div class="card-header">
                <span class="card-label">Air Quality Index</span>
                <div class="icon-box"><i class="fa-solid fa-wind"></i></div>
            </div>
            <div>
                <span class="metric-value" id="airquality">--</span><span class="metric-unit">PPM</span>
            </div>
            <div class="card-footer">
                <span>MQ135 Gas Sensor</span>
                <span id="airStatus">Normal</span>
            </div>
        </div>

        <div class="section-title">Device Control Center</div>

        <div class="control-panel">
            
            <div class="control-item" id="fanControl" onclick="toggleDevice('fan')">
                <div class="control-info">
                    <i class="fa-solid fa-fan"></i>
                    <span class="control-name">Ventilation Fan</span>
                </div>
                <div class="toggle"></div>
            </div>

            <div class="control-item" id="lightControl" onclick="toggleDevice('light')">
                <div class="control-info">
                    <i class="fa-solid fa-lightbulb"></i>
                    <span class="control-name">Main Lights</span>
                </div>
                <div class="toggle"></div>
            </div>

            <div class="control-item" id="doorControl" onclick="toggleDevice('door')">
                <div class="control-info">
                    <i class="fa-solid fa-door-open"></i>
                    <span class="control-name">Door Lock</span>
                </div>
                <div class="toggle"></div>
            </div>

            <div class="control-item" id="modeControl" onclick="toggleDevice('mode')">
                <div class="control-info">
                    <i class="fa-solid fa-robot"></i>
                    <div>
                        <span class="control-name">System Mode</span>
                        <div style="font-size: 0.75rem; color: var(--text-muted);" id="modeText">Auto</div>
                    </div>
                </div>
                <div class="toggle"></div>
            </div>

        </div>

        <div class="footer">
            <p>Last Data Update: <span id="timestamp">Waiting for data...</span></p>
        </div>

    </div>

    <div class="toast-container">
        <div id="toast" class="toast">
            <i id="toastIcon" class="fa-solid fa-circle-check"></i>
            <span id="toastMessage">Connected successfully</span>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script>
        // --- Configuration ---
        const MQTT_SERVER = "afc8a0ac2ccf462c8f92b932403518df.s1.eu.hivemq.cloud";
        const MQTT_PORT = 8884;
        const MQTT_USER = "hivemq.webclient.1761751067946";
        const MQTT_PASS = "wy.b7f8cB*0GTUW&4Ha:";
        
        const TOPIC_SENSORS = "project/sensors";
        const TOPIC_STATUS = "project/status";
        const TOPIC_CONTROL = "project/control";

        let client;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 10;

        // --- Initialization ---
        window.addEventListener('load', () => {
            connectMQTT();
        });

        // --- MQTT Logic ---
        function connectMQTT() {
            const clientId = "web-client-" + Math.random().toString(16).substr(2, 8);
            client = new Paho.MQTT.Client(MQTT_SERVER, MQTT_PORT, clientId);

            client.onConnectionLost = onConnectionLost;
            client.onMessageArrived = onMessageArrived;

            const options = {
                useSSL: true,
                userName: MQTT_USER,
                password: MQTT_PASS,
                onSuccess: onConnect,
                onFailure: onFailure,
                keepAliveInterval: 30
            };

            updateConnectionUI("connecting", "Connecting to Server...");
            client.connect(options);
        }

        function onConnect() {
            console.log("‚úÖ MQTT Connected");
            updateConnectionUI("connected", "Live Connection");
            reconnectAttempts = 0;
            
            client.subscribe(TOPIC_SENSORS);
            client.subscribe(TOPIC_STATUS);
            
            showToast("System Connected", "success");
        }

        function onFailure(error) {
            console.error("‚ùå Connection failed:", error.errorMessage);
            updateConnectionUI("disconnected", "Connection Failed");
            
            reconnectAttempts++;
            if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                setTimeout(connectMQTT, 5000);
            } else {
                showToast("Max reconnect attempts reached. Refresh page.", "error");
            }
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.warn("‚ö†Ô∏è Connection Lost:", responseObject.errorMessage);
                updateConnectionUI("disconnected", "Reconnecting...");
                setTimeout(connectMQTT, 3000);
            }
        }

        function onMessageArrived(message) {
            // console.log("üì© Data:", message.payloadString);
            try {
                const data = JSON.parse(message.payloadString);
                updateDashboard(data);
            } catch (e) {
                console.error("JSON Parse Error:", e);
            }
        }

        // --- Dashboard Logic ---
        function updateDashboard(data) {
            // Helper to set text content safely
            const setTxt = (id, val) => {
                const el = document.getElementById(id);
                if(el) el.textContent = val;
            };

            // Temperature
            if (data.dht_temp) {
                setTxt('dht-temp', data.dht_temp.toFixed(1));
                setTxt('temp', data.dht_temp.toFixed(1));
            }
            if (data.bmp_temp) setTxt('bmp-temp', data.bmp_temp.toFixed(1));

            // Humidity & Pressure
            if (data.dht_humidity) setTxt('humidity', data.dht_humidity.toFixed(1));
            if (data.pressure_hpa) setTxt('pressure', data.pressure_hpa.toFixed(1));

            // Light
            if (data.lightPercent !== undefined) setTxt('light', data.lightPercent.toFixed(0));

            // Air Quality
            if (data.mq135 !== undefined) {
                setTxt('airquality', data.mq135);
                // Dynamic feedback for air quality
                const statusEl = document.getElementById('airStatus');
                if(data.mq135 > 1000) {
                    statusEl.textContent = "Poor Quality";
                    statusEl.style.color = "var(--danger)";
                } else {
                    statusEl.textContent = "Good Quality";
                    statusEl.style.color = "var(--success)";
                }
            }

            // Controls Visualization
            updateControlState('fanControl', data.fan);
            updateControlState('lightControl', data.light);
            updateControlState('doorControl', data.door);

            // Special handling for Mode
            if (data.mode !== undefined) {
                const isManual = data.mode === "Manual";
                const modeEl = document.getElementById('modeControl');
                const modeText = document.getElementById('modeText');
                
                if (isManual) {
                    modeEl.classList.add('active', 'manual-mode');
                    modeText.textContent = "Manual Override";
                } else {
                    modeEl.classList.remove('active', 'manual-mode');
                    modeText.textContent = "Automatic Control";
                }
            }

            // Timestamp
            const now = new Date();
            setTxt('timestamp', now.toLocaleTimeString());
        }

        function updateControlState(elementId, isActive) {
            if (isActive === undefined) return;
            const el = document.getElementById(elementId);
            if (isActive) el.classList.add('active');
            else el.classList.remove('active');
        }

        function toggleDevice(device) {
            if (!client || !client.isConnected()) {
                showToast("Connection Lost - Cannot Send Command", "error");
                return;
            }

            const message = new Paho.MQTT.Message(device + "-toggle");
            message.destinationName = TOPIC_CONTROL;
            
            try {
                client.send(message);
                console.log("üì§ Sent Command:", device);
                
                // Immediate visual feedback (optimistic UI)
                const card = document.getElementById(device + 'Control');
                if(card) {
                    card.style.transform = "scale(0.98)";
                    setTimeout(() => card.style.transform = "scale(1)", 150);
                }
                
                // Special handling for mode toggle text
                if (device === 'mode') {
                    showToast("Switching System Mode...", "success");
                } else {
                    showToast(`Toggling ${device}...`, "success");
                }
                
            } catch (error) {
                console.error("Send failed:", error);
                showToast("Failed to send command", "error");
            }
        }

        // --- UI Helper Functions ---
        function updateConnectionUI(state, text) {
            const container = document.getElementById('connectionStatus');
            const txt = document.getElementById('statusText');
            
            container.className = ""; // clear classes
            if (state === 'connected') container.classList.add('connected');
            else container.classList.add('disconnected');
            
            txt.textContent = text;
        }

        function showToast(msg, type) {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toastMessage');
            const toastIcon = document.getElementById('toastIcon');

            toast.className = `toast ${type}`;
            toastMsg.textContent = msg;
            
            // Icon handling
            if (type === 'success') toastIcon.className = "fa-solid fa-circle-check";
            else toastIcon.className = "fa-solid fa-circle-exclamation";

            toast.classList.add('show');
            
            // Clear existing timeout if spamming buttons
            if (toast.timeoutId) clearTimeout(toast.timeoutId);
            
            toast.timeoutId = setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>
